"use client"

import { useMemo } from "react"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Progress } from "@/components/ui/progress"
import { Alert, AlertDescription } from "@/components/ui/alert"
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from "recharts"
import { Shield, AlertTriangle, CheckCircle2, TrendingUp } from "lucide-react"
import type { CalculationResult } from "@/lib/enhanced-tco-calculator"

interface SecurityVulnerabilityTimelineProps {
  results: CalculationResult[]
}

export default function SecurityVulnerabilityTimeline({ results }: SecurityVulnerabilityTimelineProps) {
  // Historical CVE data for major vendors (2020-2024)
  const historicalCVEData = useMemo(() => {
    return [
      { year: "2020", Cisco: 12, Aruba: 3, Forescout: 5, Juniper: 4, Extreme: 2, Fortinet: 8, Portnox: 0 },
      { year: "2021", Cisco: 15, Aruba: 4, Forescout: 7, Juniper: 6, Extreme: 3, Fortinet: 11, Portnox: 0 },
      { year: "2022", Cisco: 18, Aruba: 5, Forescout: 9, Juniper: 8, Extreme: 4, Fortinet: 14, Portnox: 0 },
      { year: "2023", Cisco: 21, Aruba: 6, Forescout: 11, Juniper: 7, Extreme: 5, Fortinet: 16, Portnox: 0 },
      { year: "2024", Cisco: 16, Aruba: 4, Forescout: 8, Juniper: 5, Extreme: 3, Fortinet: 12, Portnox: 0 },
    ]
  }, [])

  const securityMetrics = useMemo(() => {
    return results.map((result) => {
      const vendorData = result.vendorData
      const cveCount = vendorData?.security?.cveCount || 0
      const complianceScore = vendorData?.security?.complianceSupport?.length || 0

      let riskLevel = "Low"
      let riskColor = "#10b981"

      if (cveCount > 15) {
        riskLevel = "Critical"
        riskColor = "#dc2626"
      } else if (cveCount > 8) {
        riskLevel = "High"
        riskColor = "#ea580c"
      } else if (cveCount > 3) {
        riskLevel = "Medium"
        riskColor = "#d97706"
      }

      return {
        vendor: result.vendorName,
        vendorId: result.vendorId,
        cveCount,
        complianceScore,
        riskLevel,
        riskColor,
        securityRating: Math.max(100 - cveCount * 5, 0),
        isPortnox: result.vendorId === "portnox",
      }
    })
  }, [results])

  const riskDistribution = useMemo(() => {
    const distribution = securityMetrics.reduce(
      (acc, vendor) => {
        acc[vendor.riskLevel] = (acc[vendor.riskLevel] || 0) + 1
        return acc
      },
      {} as Record<string, number>,
    )

    return Object.entries(distribution).map(([level, count]) => ({
      level,
      count,
      color:
        level === "Critical" ? "#dc2626" : level === "High" ? "#ea580c" : level === "Medium" ? "#d97706" : "#10b981",
    }))
  }, [securityMetrics])

  const portnoxSecurity = securityMetrics.find((m) => m.isPortnox)
  const avgCompetitorCVEs =
    securityMetrics.filter((m) => !m.isPortnox).reduce((sum, m) => sum + m.cveCount, 0) /
    Math.max(securityMetrics.filter((m) => !m.isPortnox).length, 1)

  return (
    <div className="space-y-6">
      {/* Security Overview Cards */}
      <div className="grid gap-4 md:grid-cols-4">
        <Card className="border-green-200 bg-green-50 dark:bg-green-950/20">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <Shield className="h-4 w-4 text-green-600" />
              Portnox CVEs
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-green-700">0</div>
            <p className="text-xs text-green-600 mt-1">Zero vulnerabilities</p>
          </CardContent>
        </Card>

        <Card className="border-red-200 bg-red-50 dark:bg-red-950/20">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <AlertTriangle className="h-4 w-4 text-red-600" />
              Competitor Average
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-red-700">{Math.round(avgCompetitorCVEs)}</div>
            <p className="text-xs text-red-600 mt-1">CVEs per vendor</p>
          </CardContent>
        </Card>

        <Card className="border-blue-200 bg-blue-50 dark:bg-blue-950/20">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <CheckCircle2 className="h-4 w-4 text-blue-600" />
              Security Rating
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-blue-700">{portnoxSecurity?.securityRating || 100}</div>
            <p className="text-xs text-blue-600 mt-1">out of 100</p>
          </CardContent>
        </Card>

        <Card className="border-purple-200 bg-purple-50 dark:bg-purple-950/20">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium flex items-center gap-2">
              <TrendingUp className="h-4 w-4 text-purple-600" />
              Risk Reduction
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-purple-700">100%</div>
            <p className="text-xs text-purple-600 mt-1">vs traditional NAC</p>
          </CardContent>
        </Card>
      </div>

      {/* Security Alert */}
      <Alert className="border-green-200 bg-green-50">
        <Shield className="h-4 w-4 text-green-600" />
        <AlertDescription className="text-green-800">
          <div className="space-y-2">
            <div>
              <strong>Zero CVE Track Record:</strong> Portnox CLEAR maintains a perfect security record with zero Common
              Vulnerabilities and Exposures (CVEs) since inception, while traditional NAC vendors average
              {Math.round(avgCompetitorCVEs)} CVEs annually.
            </div>
            <div className="text-sm">
              This cloud-native, secure-by-design architecture eliminates the attack surface that plagues on-premise NAC
              appliances.
            </div>
          </div>
        </AlertDescription>
      </Alert>

      {/* Historical CVE Timeline */}
      <Card>
        <CardHeader>
          <CardTitle>Historical CVE Timeline (2020-2024)</CardTitle>
          <CardDescription>Common Vulnerabilities and Exposures by vendor over time</CardDescription>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={400}>
            <LineChart data={historicalCVEData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="year" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Line type="monotone" dataKey="Portnox" stroke="#10b981" strokeWidth={4} name="Portnox CLEAR" />
              <Line type="monotone" dataKey="Cisco" stroke="#dc2626" strokeWidth={2} name="Cisco ISE" />
              <Line type="monotone" dataKey="Aruba" stroke="#ea580c" strokeWidth={2} name="Aruba ClearPass" />
              <Line type="monotone" dataKey="Forescout" stroke="#d97706" strokeWidth={2} name="Forescout" />
              <Line type="monotone" dataKey="Juniper" stroke="#7c3aed" strokeWidth={2} name="Juniper Mist" />
              <Line type="monotone" dataKey="Extreme" stroke="#0891b2" strokeWidth={2} name="Extreme NAC" />
              <Line type="monotone" dataKey="Fortinet" stroke="#be123c" strokeWidth={2} name="Fortinet" />
            </LineChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      {/* Security Risk Distribution and Detailed Metrics */}
      <div className="grid gap-6 lg:grid-cols-2">
        <Card>
          <CardHeader>
            <CardTitle>Security Risk Distribution</CardTitle>
            <CardDescription>Vendor risk levels based on CVE count</CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={riskDistribution}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({ level, count }) => `${level}: ${count}`}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="count"
                >
                  {riskDistribution.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Detailed Security Metrics</CardTitle>
            <CardDescription>Security scores and compliance ratings</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {securityMetrics
                .sort((a, b) => a.cveCount - b.cveCount)
                .map((vendor) => (
                  <div key={vendor.vendorId} className="space-y-2">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="font-medium text-sm">{vendor.vendor}</span>
                        <Badge
                          variant={vendor.riskLevel === "Low" ? "outline" : "destructive"}
                          className="text-xs"
                          style={{
                            borderColor: vendor.riskColor,
                            color: vendor.riskLevel === "Low" ? vendor.riskColor : "white",
                            backgroundColor: vendor.riskLevel === "Low" ? "transparent" : vendor.riskColor,
                          }}
                        >
                          {vendor.riskLevel} Risk
                        </Badge>
                      </div>
                      <div className="text-right">
                        <div className="font-medium text-sm">{vendor.cveCount} CVEs</div>
                        <div className="text-xs text-muted-foreground">{vendor.securityRating}/100 rating</div>
                      </div>
                    </div>
                    <Progress
                      value={vendor.securityRating}
                      className="h-2"
                      style={{
                        backgroundColor: vendor.isPortnox ? "#dcfce7" : "#fee2e2",
                      }}
                    />
                    <div className="flex justify-between text-xs text-muted-foreground">
                      <span>Compliance: {vendor.complianceScore} frameworks</span>
                      <span>Security Score: {vendor.securityRating}%</span>
                    </div>
                  </div>
                ))}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Critical Security Advantages */}
      <Card className="border-green-200 bg-green-50 dark:bg-green-950/20">
        <CardHeader>
          <CardTitle className="text-green-800">Portnox Security Advantages</CardTitle>
          <CardDescription className="text-green-700">Why Portnox CLEAR maintains zero vulnerabilities</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            <div className="text-center p-4 rounded-lg border border-green-200">
              <Shield className="h-8 w-8 text-green-600 mx-auto mb-2" />
              <div className="font-semibold text-green-800">Cloud-Native</div>
              <div className="text-xs text-green-600 mt-1">No on-premise attack surface</div>
            </div>
            <div className="text-center p-4 rounded-lg border border-green-200">
              <CheckCircle2 className="h-8 w-8 text-green-600 mx-auto mb-2" />
              <div className="font-semibold text-green-800">Secure by Design</div>
              <div className="text-xs text-green-600 mt-1">Built-in security controls</div>
            </div>
            <div className="text-center p-4 rounded-lg border border-green-200">
              <TrendingUp className="h-8 w-8 text-green-600 mx-auto mb-2" />
              <div className="font-semibold text-green-800">Auto-Updates</div>
              <div className="text-xs text-green-600 mt-1">Always current, no patches</div>
            </div>
            <div className="text-center p-4 rounded-lg border border-green-200">
              <AlertTriangle className="h-8 w-8 text-green-600 mx-auto mb-2" />
              <div className="font-semibold text-green-800">Zero Trust</div>
              <div className="text-xs text-green-600 mt-1">Continuous verification</div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
